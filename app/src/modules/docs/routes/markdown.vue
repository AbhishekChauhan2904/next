<template>
	<div class="docs selectable">
		<div class="md" v-html="html" />
	</div>
</template>

<script lang="ts">
import { defineComponent, ref, computed, watch, PropType, onMounted, onUpdated } from '@vue/composition-api';
import marked from 'marked';
import highlight from 'highlight.js';

export default defineComponent({
	setup(props, { slots }) {
		const html = ref('');

		onMounted(generateHTML);
		onUpdated(generateHTML);

		return { html };

		function generateHTML() {
			if (slots.default === null || !slots.default()?.[0]?.text) {
				html.value = '';
				return;
			}

			let htmlString = marked(slots.default()[0].text!, {
				highlight: (code) => highlight.highlightAuto(code).value,
			});

			const hintRegex = /:::(.*?) (.*?)\n((\s|.)*?):::/gm;

			htmlString = htmlString.replaceAll(
				hintRegex,
				(match: string, type: string, title: string, body: string) => {
					return `<div class="hint ${type}"><p class="hint-title">${title}</p><p class="hint-body">${body}</p></div>`;
				}
			);

			html.value = htmlString;
		}
	},
});
</script>

<style lang="scss" scoped>
.error {
	padding: 20vh 0;
}

.docs {
	padding: var(--content-padding);
	padding-bottom: var(--content-padding-bottom);

	.md {
		max-width: 740px;

		::v-deep {
			font-weight: 500;
			font-size: 14px;

			& > *:first-child {
				margin-top: 0;
			}

			& > *:last-child {
				margin-bottom: 0;
			}

			a {
				text-decoration: underline;
			}

			h1,
			h2,
			h3,
			h4,
			h5,
			h6 {
				position: relative;
				margin: 20px 0 10px;
				padding: 0;
				font-weight: 600;
				cursor: text;
			}

			pre {
				padding: 6px 10px;
				overflow: auto;
				font-size: 13px;
				line-height: 19px;
				background-color: var(--background-page);
				border: 1px solid var(--background-normal);
				border-radius: var(--border-radius);
			}

			code,
			tt {
				margin: 0 2px;
				padding: 0 5px;
				white-space: nowrap;
				background-color: var(--background-page);
				border: 1px solid var(--background-normal);
				border-radius: var(--border-radius);
			}

			pre code {
				margin: 0;
				padding: 0;
				white-space: pre;
				background: transparent;
				border: none;
			}

			pre code,
			pre tt {
				background-color: transparent;
				border: none;
			}

			h1 tt,
			h1 code {
				font-size: inherit;
			}

			h2 tt,
			h2 code {
				font-size: inherit;
			}

			h3 tt,
			h3 code {
				font-size: inherit;
			}

			h4 tt,
			h4 code {
				font-size: inherit;
			}

			h5 tt,
			h5 code {
				font-size: inherit;
			}
			h6 tt,
			h6 code {
				font-size: inherit;
			}

			h1 {
				font-size: 28px;
			}

			h2 {
				font-size: 24px;
			}

			h3 {
				font-size: 18px;
			}

			h4 {
				font-size: 16px;
			}

			h5 {
				font-size: 14px;
			}

			h6 {
				color: var(--foreground-normal);
				font-size: 14px;
			}

			p,
			blockquote,
			ul,
			ol,
			dl,
			li,
			table,
			pre {
				margin: 15px 0;
			}

			& > h2:first-child {
				margin-top: 0;
				padding-top: 0;
			}

			& > h1:first-child {
				margin-top: 0;
				padding-top: 0;
			}

			& > h3:first-child,
			& > h4:first-child,
			& > h5:first-child,
			& > h6:first-child {
				margin-top: 0;
				padding-top: 0;
			}

			a:first-child h1,
			a:first-child h2,
			a:first-child h3,
			a:first-child h4,
			a:first-child h5,
			a:first-child h6 {
				margin-top: 0;
				padding-top: 0;
			}

			h1 p,
			h2 p,
			h3 p,
			h4 p,
			h5 p,
			h6 p {
				margin-top: 0;
			}

			li p.first {
				display: inline-block;
			}

			ul,
			ol {
				padding-left: 30px;

				li {
					margin: 0;
				}
			}

			ul :first-child,
			ol :first-child {
				margin-top: 0;
			}

			ul :last-child,
			ol :last-child {
				margin-bottom: 0;
			}

			blockquote {
				padding: 0 15px;
				color: var(--foreground-normal);
				border-left: 4px solid var(--background-normal);
			}

			blockquote > :first-child {
				margin-top: 0;
			}

			blockquote > :last-child {
				margin-bottom: 0;
			}

			table {
				padding: 0;
				border-collapse: collapse;
				border-spacing: 0;
			}

			table tr {
				margin: 0;
				padding: 0;
				background-color: white;
				border-top: 1px solid var(--background-normal);
			}

			table tr:nth-child(2n) {
				background-color: var(--background-page);
			}

			table tr th {
				margin: 0;
				padding: 6px 13px;
				font-weight: bold;
				text-align: left;
				border: 1px solid var(--background-normal);
			}

			table tr td {
				margin: 0;
				padding: 6px 13px;
				text-align: left;
				border: 1px solid var(--background-normal);
			}

			table tr th :first-child,
			table tr td :first-child {
				margin-top: 0;
			}

			table tr th :last-child,
			table tr td :last-child {
				margin-bottom: 0;
			}

			img {
				max-width: 100%;
			}

			.highlight pre {
				padding: 6px 10px;
				overflow: auto;
				font-size: 13px;
				line-height: 19px;
				background-color: var(--background-page);
				border: 1px solid var(--background-normal);
				border-radius: var(--border-radius);
			}

			hr {
				margin: 20px auto;
				border: none;
				border-top: 1px solid var(--background-normal);
			}

			b,
			strong {
				font-weight: 600;
			}

			.hint {
				display: inline-block;
				padding: 0 16px;
				background-color: var(--background-subdued);
				border-left: 8px solid var(--primary);

				&-title {
					font-weight: bold;
				}

				&.tip {
					border-left: 8px solid var(--success);
				}

				&.warning {
					border-left: 8px solid var(--warning);
				}

				&.danger {
					border-left: 8px solid var(--danger);
				}
			}
		}
	}
}
</style>
